#!/bin/bash

# Bit of common bash magic that sets DIR to the directory of this script
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
# The path to the working directory - the root of the repo
REPO_DIR=$DIR/../

echo $GOOGLE_APPLICATION_CREDENTIALS_CONTENT > /tmp/account.json
export GOOGLE_APPLICATION_CREDENTIALS=/tmp/account.json

source $REPO_DIR/bin/install-ci-tools

gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS
source $REPO_DIR/bin/setup-kind

echo "Deploying Astronomer..."


set +ex

kubectl get pods -n astronomer -w &
WATCH_PID=$!

helm install \
  --wait \
  --namespace astronomer \
  -n astronomer \
  -f configs/local-dev.yaml \
  --set tags.platform=true \
  --set tags.logging=true \
  --set tags.monitoring=true \
  --set tags.kubed=true \
  $REPO_DIR

HELM_CODE=$?
kill $WATCH_PID

if [ $HELM_CODE -eq 0 ]; then
  echo "Astronomer deployed!"
else
  echo "Failed to deploy Astronomer!"
  echo "Printing description and logs where containers in pod are not 1/1..."
  for pod in $(kubectl get pods -n astronomer | grep -v NAME | grep 1/1 | awk '{ print $1 }'); do
    echo "======================="
    set -x
    kubectl describe pod -n astronomer $pod
    kubectl logs -n astronomer $pod
    set +x
    echo "======================="
  done
if

kubectl get pods --all-namespaces

exit $HELM_CODE
