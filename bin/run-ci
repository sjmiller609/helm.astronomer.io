#!/bin/bash

# Bit of common bash magic that sets DIR to the directory of this script
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
# The path to the working directory - the root of the repo
REPO_DIR=$DIR/../

echo $GOOGLE_APPLICATION_CREDENTIALS_CONTENT > /tmp/account.json
export GOOGLE_APPLICATION_CREDENTIALS=/tmp/account.json

source $REPO_DIR/bin/install-ci-tools

gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS
source $REPO_DIR/bin/setup-kind

set -e

echo "Deploying Astronomer..."
helm install -f configs/local-dev.yaml \
  --namespace astronomer -n astronomer \
  --wait \
  $REPO_DIR

echo "Astronomer deployed"

kubectl get pods --all-namespaces
